name: Deploy Total360 Backend to VPS

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        type: string
        default: 'main'
      environment:
        description: 'Deployment environment (dev or prod)'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: ðŸŽ¯ Set deployment config
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV

          if [ "$ENV" = "prod" ]; then
            echo "DEPLOY_PATH=/var/www/total360-backend" >> $GITHUB_ENV
            echo "APP_NAME=total360-backend" >> $GITHUB_ENV
            echo "COMPOSE_FILES=docker-compose.yml:docker-compose.prod.yml" >> $GITHUB_ENV
          else
            echo "DEPLOY_PATH=/var/www/total360-backend-dev" >> $GITHUB_ENV
            echo "APP_NAME=total360-backend-dev" >> $GITHUB_ENV
            echo "COMPOSE_FILES=docker-compose.yml:docker-compose.dev.yml" >> $GITHUB_ENV
          fi
          # Set deploy user from secret or default to root
          if [ -z "${{ secrets.DEPLOY_USER }}" ]; then
            echo "DEPLOY_USER=root" >> $GITHUB_ENV
          else
            echo "DEPLOY_USER=${{ secrets.DEPLOY_USER }}" >> $GITHUB_ENV
          fi

      - name: âš™ï¸ Set deployment configuration
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write private key directly from GitHub secret (same approach as frontend workflow)
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add server to known hosts to avoid interactive prompt
          ssh-keyscan -H "${{ secrets.SERVER_IP }}" >> ~/.ssh/known_hosts

      - name: ðŸ› ï¸ Install rsync and ssh client
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            if command -v sudo >/dev/null 2>&1; then
              sudo apt-get update || true
              sudo apt-get install -y rsync openssh-client ca-certificates || true
            else
              apt-get update || true
              apt-get install -y rsync openssh-client ca-certificates || true
            fi
          else
            echo "apt-get not available in this runner; skipping package install"
          fi

      - name: ðŸ“¤ Sync source code to server
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "venv" \
            --exclude "node_modules" \
            ./ ${DEPLOY_USER}@${{ secrets.SERVER_IP }}:${{ env.DEPLOY_PATH }}

      - name: ðŸš€ Deploy application on server
        run: |
          ssh ${DEPLOY_USER}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            export ENVIRONMENT=${{ env.ENVIRONMENT }}
            docker compose -f docker-compose.yml -f docker-compose.${{ env.ENVIRONMENT }}.yml up -d --build
          EOF

      - name: âœ… Deployment finished
        run: |
          echo "Deployment to ${{ github.event.inputs.environment }} (branch: ${{ github.event.inputs.branch }}) completed."
